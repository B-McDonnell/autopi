#!/usr/bin/env bash

# ============================
#  Check for root privileges
# ============================

id=`id -u`
if test $id != 0; then
    echo "Run this script as root" # prompt and exit if standard user
    exit 1
fi


# ============================
#  Perform miscellaneous setup
# ============================

touch /boot/ssh # enable ssh
mkdir /var/opt/autopi  # create directory for script generated files


# ============================
#     install dependencies
# ============================

# Install any necessary python packages
pip3 install -r requirements.txt


# ==============================================================
#   add scripts to install location; add to /usr/bin as needed
# ==============================================================

SCRIPT_DIR="/opt/autopi/"
mkdir -p $"SCRIPT_DIR"

function move_pyscript() {
    #if [ -z "$1" ]; then return 0; fi
    stem=`basename "$1" .py` # strip extension
    name="$stem".py
    cp ./src/scripts/"$name" "$SCRIPT_DIR"/
    if [ "$2" == "command" ]; then
        prefix='CSM_'
        chmod +x "$SCRIPT_DIR"/"$name"
        ln -s "$SCRIPT_DIR"/"$name" /usr/bin/"$prefix""$stem"
    elif [ ! -z "$2" ]; then
        echo "Invalid parameter"
        return 1
    fi
}

move_pyscript get_config
move_pyscript get_ip
move_pyscript get_ssid
move_pyscript get_hw_id
move_pyscript get_dev_id

move_pyscript get_mac command
move_pyscript add_network command
move_pyscript generate_request command
move_pyscript setup_home_network command
move_pyscript add_network_from_txt command
move_pyscript wpa_country command


# ============================
#      run initial setup
# ============================

# add country information to network discovery system
CSM_wpa_country get 1>/dev/null
if [ $? -ne 0 ]; then
    CSM_wpa_country update US
fi
# add guest network by default
CSM_add_network --no-password --priority=2 CSMwireless


# ===================================================
#      write MAC address to boot (CSM_mac.txt)
# ===================================================

# adds mac address to file in boot called "CSM_mac.txt"
WRITE_MAC_COMMAND="CSM_get_mac wlan0 > /boot/CSM_mac.txt"
WRITE_MAC_CRON="@reboot $WRITE_MAC_COMMAND"
crontab -l >/tmp/crontab_r 2>/dev/null
grep -Fx "$WRITE_MAC_CRON" /tmp/crontab_r >/dev/null
if [ "$?" -ne 0 ]; then
    echo "$WRITE_MAC_CRON">>/tmp/crontab_r
fi
crontab /tmp/crontab_r


# =============================================================
#      add network specified in file (CSM_new_network.txt)
# =============================================================

# adds network according to information in file

# TODO: change reset command to copy a blank file to boot everytime
ADD_NET_COMMAND = "CSM_add_network_from_txt"
ADD_RESET_COMMAND="printf '%s\n' '# No space after (=).' '# Priority is an int value 1,2, or 3 (3 being prioritized the most).' '# If no password/priority, leave empty.' '# This file will be reset after network is added.' 'ssid=' 'password=' 'priority=' > /boot/CSM_new_network.txt"


ADD_NET_CRON="@reboot $ADD_NET_COMMAND; $ADD_RESET_COMMAND"
crontab -l >/tmp/crontab_r 2>/dev/null
grep -Fx "$ADD_NET_CRON" /tmp/crontab_r >/dev/null
if [ "$?" -ne 0 ]; then
    echo "$ADD_NET_CRON">>/tmp/crontab_r
fi
crontab /tmp/crontab_r

# =============================================================
#		Install systemd unit files
# =============================================================

function add_systemd_unit() {
	if [ -z "$1" ]; then
		echo "Missing parameter"
		return 1
	fi
	TNAME=$(basename "$1")
	cp "$1" "/etc/systemd/system/$TNAME"
	if [ "enable" == "$2" ]; then
		systemctl enable $TNAME
	elif [ "noenable" != "$2" ]; then
		echo "Invalid parameter"
		echo "Usage: add_systemd_unit PATH_TO_UNIT (enable | noenable)"
	fi
}

# add units for startup+shutdown+periodic IP Discovery requests
add_systemd_unit src/systemdunits/autopi-periodic.service noenable
add_systemd_unit src/systemdunits/autopi-periodic.timer enable
add_systemd_unit src/systemdunits/autopi-shutdown.service enable
add_systemd_unit src/systemdunits/autopi-startup.service enable

systemctl daemon-reload 
