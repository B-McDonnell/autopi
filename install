#!/usr/bin/env bash

# ============================
#  Check for root privileges
# ============================

id=`id -u`
if test $id != 0; then
    echo "Run this script as root" # prompt and exit if standard user
    exit 1
fi


# ============================
#  Perform miscellaneous setup
# ============================

touch /boot/ssh # enable ssh


# ============================
#     install dependencies
# ============================

# Install any necessary python packages
pip3 install -r requirements.txt


# ============================
#   move scripts to /usr/bin
# ============================

cp ./src/scripts/CSM_getip.py /usr/bin/CSM_getip
chmod +x /usr/bin/CSM_getip

cp ./src/scripts/CSM_getssid.py /usr/bin/CSM_getssid
chmod +x /usr/bin/CSM_getssid

cp ./src/scripts/CSM_get_mac.py /usr/bin/CSM_get_mac
chmod +x /usr/bin/CSM_get_mac

cp ./src/scripts/CSM_add_network.py /usr/bin/CSM_add_network
chmod +x /usr/bin/CSM_add_network

cp ./src/scripts/CSM_wpa_country.py /usr/bin/CSM_wpa_country
chmod +x /usr/bin/CSM_wpa_country

cp ./src/scripts/CSM_setup_home_network.py /usr/bin/CSM_setup_home_network
chmod +x /usr/bin/CSM_setup_home_network

cp ./src/scripts/CSM_get_hw_id.py /usr/bin/CSM_get_hw_id
chmod +x /usr/bin/CSM_get_hw_id

cp ./src/scripts/CSM_add_network_from_txt.py /usr/bin/CSM_add_network_from_txt.py
chmod +x /usr/bin/CSM_add_network_from_txt.py


# ============================
#      run initial setup
# ============================

# add country information to network discovery system
CSM_wpa_country get 1>/dev/null
if [ $? -ne 0 ]; then
    CSM_wpa_country update US
fi
# add guest network by default
CSM_add_network --no-password --priority=2 CSMwireless


# ===================================================
#      write MAC address to boot (CSM_mac.txt)
# ===================================================

# adds mac address to file in boot called "CSM_mac.txt"
WRITE_MAC_COMMAND="CSM_get_mac wlan0 > /boot/CSM_mac.txt"
WRITE_MAC_CRON="@reboot $WRITE_MAC_COMMAND"
crontab -l >/tmp/crontab_r 2>/dev/null
grep -Fx "$WRITE_MAC_CRON" /tmp/crontab_r >/dev/null
if [ "$?" -ne 0 ]; then
    echo "$WRITE_MAC_CRON">>/tmp/crontab_r
fi
crontab /tmp/crontab_r


# =============================================================
#      add network specified in file (CSM_new_network.txt)
# =============================================================

# adds network according to information in file

# TODO: change reset command to copy a blank file to boot everytime
ADD_NET_COMMAND = "CSM_add_network_from_txt"
ADD_RESET_COMMAND="printf '%s\n' '# No space after (=).' '# Priority is an int value 1,2, or 3 (3 being prioritized the most).' '# If no password/priority, leave empty.' '# This file will be reset after network is added.' 'ssid=' 'password=' 'priority=' > /boot/CSM_new_network.txt"


ADD_NET_CRON="@reboot $ADD_NET_COMMAND; $ADD_RESET_COMMAND"
crontab -l >/tmp/crontab_r 2>/dev/null
grep -Fx "$ADD_NET_CRON" /tmp/crontab_r >/dev/null
if [ "$?" -ne 0 ]; then
    echo "$ADD_NET_CRON">>/tmp/crontab_r
fi
crontab /tmp/crontab_r
